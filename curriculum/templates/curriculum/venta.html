{% extends 'curriculum/base.html' %}

{% block title %}Venta de Garage | Milenka Viera{% endblock %}

{% block content %}
<div class="fade-in relative pb-24 px-4 md:px-12 bg-[#08080a] min-h-screen text-white font-sans selection:bg-cyan-500 selection:text-white overflow-x-hidden">
    
    <div class="fixed inset-0 pointer-events-none z-0">
        <div class="absolute top-[-10%] left-[-5%] w-[40%] h-[40%] bg-cyan-600/15 rounded-full blur-[100px]"></div>
        <div class="absolute bottom-[-10%] right-[-5%] w-[40%] h-[40%] bg-purple-600/15 rounded-full blur-[100px]"></div>
        <div class="absolute inset-0 opacity-[0.15]" style="background-image: url('https://grainy-gradients.vercel.app/noise.svg');"></div>
    </div>

    <div class="fixed bottom-8 right-8 z-[110] no-print">
        <button type="button" onclick="toggleCartModal()" class="group relative bg-black/60 backdrop-blur-md border border-white/10 w-16 h-16 rounded-2xl flex items-center justify-center hover:border-cyan-400 transition-all duration-300 shadow-[0_0_30px_rgba(0,0,0,0.5)]">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-cyan-400 group-hover:text-purple-400 transition-colors">
                <path d="M6 2 3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z"/><path d="M3 6h18"/><path d="M16 10a4 4 0 0 1-8 0"/>
            </svg>
            <span id="cart-count" class="absolute -top-2 -right-2 bg-gradient-to-tr from-cyan-500 to-purple-600 text-[10px] font-bold w-6 h-6 flex items-center justify-center rounded-full border-2 border-[#08080a] scale-0 transition-transform">0</span>
        </button>
    </div>

    <div class="mb-20 pt-24 relative max-w-7xl mx-auto z-10">
        <div class="flex items-center gap-3 mb-4">
            <span class="bg-cyan-500 w-2 h-2 rounded-full animate-ping"></span>
            <span class="text-cyan-400 text-[10px] tracking-[0.4em] font-bold uppercase">System_Status // Online</span>
        </div>
        
        <h2 class="relative text-[clamp(3rem,10vw,8rem)] font-black italic leading-none tracking-tighter">
            <span class="block text-white opacity-90">VENTA</span>
            <span class="block bg-gradient-to-r from-cyan-400 to-purple-500 bg-clip-text text-transparent filter drop-shadow-[0_5px_15px_rgba(34,211,238,0.3)]">
                GARAGE
            </span>
            <span class="absolute top-0 right-0 md:right-40 text-white/5 text-[0.5em] not-italic font-serif [writing-mode:vertical-rl]">呪術高専</span>
        </h2>
    </div>

    <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-8 max-w-7xl mx-auto relative z-10">
        {% for item in productos %}
        <div class="group relative bg-[#121214] border border-white/5 rounded-[2.5rem] p-4 transition-all duration-500 hover:border-cyan-500/30 hover:shadow-[0_20px_50px_rgba(0,0,0,0.4)] {% if item.stock <= 0 %}opacity-40 grayscale{% endif %}">
            
            <div class="absolute top-6 left-6 z-20">
                <div class="bg-black/50 backdrop-blur-md border border-white/10 px-4 py-1.5 rounded-full">
                    <span class="text-sm font-bold text-cyan-400 tracking-tighter">${{ item.precio|floatformat:0 }}</span>
                </div>
            </div>

            <div class="w-full h-80 overflow-hidden rounded-[2rem] bg-black/40 relative flex items-center justify-center transition-all duration-700 group-hover:bg-black/20">
                <div class="absolute inset-0 bg-[radial-gradient(circle_at_center,rgba(34,211,238,0.05),transparent_70%)]"></div>
                
                {% if item.imagen %}
                    <img src="{{ item.imagen.url }}" class="w-full h-full object-contain z-10 p-8 scale-100 group-hover:scale-110 transition-transform duration-700">
                {% else %}
                    <svg xmlns="http://www.w3.org/2000/svg" width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="text-white/10">
                        <path d="m7.5 4.27 9 5.15"/><path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"/><path d="m3.3 7 8.7 5 8.7-5"/><path d="M12 22V12"/>
                    </svg>
                {% endif %}
            </div>
            
            <div class="p-6">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-2">
                        <span class="text-[9px] font-black text-white/30 tracking-[0.3em] uppercase">Grade_S // {{ item.stock }} Unit</span>
                    </div>
                    
                    <span class="text-[9px] font-bold px-2 py-0.5 rounded border uppercase tracking-widest
                        {% if item.estado|lower == 'nuevo' %}
                            border-emerald-500/40 text-emerald-400 bg-emerald-500/10
                        {% elif item.estado|lower == 'como nuevo' or item.estado|lower == 'casi nuevo' %}
                            border-cyan-500/40 text-cyan-400 bg-cyan-500/10
                        {% else %}
                            border-amber-500/40 text-amber-400 bg-amber-500/10
                        {% endif %}">
                        {{ item.estado|default:"Usado" }}
                    </span>
                </div>

                <h3 class="text-xl font-bold uppercase italic mb-3 tracking-tight group-hover:text-cyan-400 transition-colors">
                    {{ item.nombre_producto }}
                </h3>
                <p class="text-white/40 text-[11px] leading-relaxed line-clamp-2 italic mb-6">
                    {{ item.descripcion }}
                </p>
                
                <div class="flex items-center gap-3">
                    {% if item.stock > 0 %}
                    <div class="flex items-center bg-black/40 border border-white/5 rounded-full px-2">
                        <button onclick="decrementQty('{{ item.id }}')" class="p-3 text-white/20 hover:text-cyan-400 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/></svg>
                        </button>
                        <input type="number" id="qty-{{ item.id }}" value="1" class="bg-transparent w-6 text-center font-bold text-xs outline-none" readonly>
                        <button onclick="incrementQty('{{ item.id }}')" class="p-3 text-white/20 hover:text-purple-400 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg>
                        </button>
                    </div>
                    <button onclick="addToCart('{{ item.id }}', '{{ item.nombre_producto|escapejs }}', '{{ item.precio|default:0 }}', '{% if item.imagen %}{{ item.imagen.url }}{% endif %}', 'qty-{{ item.id }}')" 
                            class="flex-grow bg-white text-black h-12 rounded-full font-black text-[10px] tracking-widest hover:bg-cyan-500 hover:text-white transition-all active:scale-95 shadow-lg">
                        AÑADIR AL ALMACÉN
                    </button>
                    {% else %}
                    <div class="w-full py-3 bg-white/5 text-white/20 text-center rounded-full text-[10px] font-bold tracking-[0.3em] border border-white/5 uppercase">
                        Agotado
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<div id="cart-modal" class="fixed inset-0 z-[150] hidden flex justify-end">
    <div class="absolute inset-0 bg-black/80 backdrop-blur-xl" onclick="toggleCartModal()"></div>
    <div class="relative w-full max-w-md bg-[#0a0a0c] border-l border-white/10 flex flex-col shadow-2xl">
        <div class="p-8 border-b border-white/10 bg-[linear-gradient(to_bottom,rgba(34,211,238,0.05),transparent)]">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-3xl font-black italic uppercase">ALMACÉN</h3>
                <button onclick="toggleCartModal()" class="w-10 h-10 flex items-center justify-center rounded-full bg-white/5 hover:bg-red-500/20 hover:text-red-500 transition-all">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                </button>
            </div>
            <p id="modal-count" class="text-[9px] font-bold text-cyan-400 tracking-[0.4em] uppercase">0 Objetos Purificados</p>
        </div>
        <div id="cart-items" class="flex-grow overflow-y-auto p-8 space-y-6 no-scrollbar"></div>
        <div class="p-8 bg-black/40 border-t border-white/10">
            <div class="flex justify-between items-center mb-8">
                <span class="text-[10px] font-bold text-white/30 tracking-widest uppercase">Energía Requerida</span>
                <span id="cart-total" class="text-4xl font-black text-white">$0</span>
            </div>
            <a id="whatsapp-checkout" href="#" target="_blank" class="w-full py-5 bg-gradient-to-r from-cyan-500 to-purple-600 text-white rounded-[1.5rem] font-black uppercase text-[11px] tracking-[0.2em] text-center block hover:shadow-[0_0_30px_rgba(59,130,246,0.3)] transition-all">
                VERIFICAR VÍA WHATSAPP
            </a>
        </div>
    </div>
</div>

<style>
    @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:ital,wght@0,400;0,800;1,800&display=swap');
    body { font-family: 'Plus Jakarta Sans', sans-serif; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    .fade-in { animation: fadeIn 1s cubic-bezier(0.16, 1, 0.3, 1); }
    @keyframes fadeIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }
</style>

<script>
    let cart = [];
    function incrementQty(id) {
        const input = document.getElementById('qty-' + id);
        if(input) input.value = parseInt(input.value) + 1;
    }
    function decrementQty(id) {
        const input = document.getElementById('qty-' + id);
        if(input && parseInt(input.value) > 1) input.value = parseInt(input.value) - 1;
    }
    function toggleCartModal() {
        const modal = document.getElementById('cart-modal');
        modal.classList.toggle('hidden');
        if (!modal.classList.contains('hidden')) renderCart();
    }
    function addToCart(id, name, price, image, inputId) {
        const input = document.getElementById(inputId);
        const qty = input ? parseInt(input.value) : 1;
        const cleanPrice = parseFloat(price.toString().replace(',', '.')) || 0;
        const existingItem = cart.find(i => i.id === id);
        if (existingItem) existingItem.quantity += qty;
        else cart.push({ id, name, price: cleanPrice, image, quantity: qty });
        updateCartBadge();
        if(input) input.value = 1;
        const btn = event.currentTarget;
        const originalText = btn.innerText;
        btn.innerText = 'LISTO';
        btn.classList.add('bg-cyan-500', 'text-white');
        setTimeout(() => {
            btn.innerText = originalText;
            btn.classList.remove('bg-cyan-500', 'text-white');
        }, 800);
    }
    function updateCartBadge() {
        const badge = document.getElementById('cart-count');
        const count = cart.reduce((acc, curr) => acc + curr.quantity, 0);
        if (badge) {
            badge.innerText = count;
            count > 0 ? badge.classList.add('scale-100') : badge.classList.remove('scale-100');
        }
        document.getElementById('modal-count').innerText = `${count} OBJETOS PURIFICADOS`;
    }
    function removeFromCart(index) {
        cart.splice(index, 1);
        renderCart();
        updateCartBadge();
    }
    function renderCart() {
        const container = document.getElementById('cart-items');
        const totalEl = document.getElementById('cart-total');
        const checkoutBtn = document.getElementById('whatsapp-checkout');
        if (cart.length === 0) {
            container.innerHTML = `<div class="py-20 text-center opacity-20"><p class="text-[10px] font-bold tracking-widest uppercase">Dominio Vacío</p></div>`;
            totalEl.innerText = "$0";
            checkoutBtn.classList.add('opacity-30', 'pointer-events-none');
            return;
        }
        let subtotal = 0;
        container.innerHTML = cart.map((item, index) => {
            subtotal += (item.price * item.quantity);
            return `
                <div class="flex items-center gap-4 bg-white/5 p-4 rounded-2xl border border-white/5">
                    <div class="w-16 h-16 bg-black rounded-xl overflow-hidden shrink-0">
                        ${item.image ? `<img src="${item.image}" class="w-full h-full object-contain">` : `<div class="w-full h-full flex items-center justify-center text-white/10"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m7.5 4.27 9 5.15"/><path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"/><path d="m3.3 7 8.7 5 8.7-5"/><path d="M12 22V12"/></svg></div>`}
                    </div>
                    <div class="flex-grow">
                        <h4 class="text-[10px] font-black uppercase text-white tracking-tight">${item.name}</h4>
                        <p class="text-cyan-400 font-bold text-[10px]">${item.quantity} x $${item.price.toLocaleString()}</p>
                    </div>
                    <button onclick="removeFromCart(${index})" class="text-white/20 hover:text-red-500 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
                    </button>
                </div>`;
        }).join('');
        totalEl.innerText = `$${subtotal.toLocaleString()}`;
        checkoutBtn.classList.remove('opacity-30', 'pointer-events-none');
        const message = encodeURIComponent(`NUEVO PEDIDO:\n` + cart.map(i => `• ${i.quantity}x ${i.name} ($${(i.price * i.quantity).toLocaleString()})`).join('\n') + `\n\nTOTAL: $${subtotal.toLocaleString()}`);
        checkoutBtn.href = `https://wa.me/593{{ perfil.telefono }}?text=${message}`;
    }
</script>
{% endblock %}